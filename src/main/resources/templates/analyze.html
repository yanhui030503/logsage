<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>æ—¥å¿—åˆ†æ - LogSage</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
	<div class="container">
		<div class="nav">
			<span>LogSage</span>
			<div>
				<a th:href="@{/analyze}">åˆ†æ</a>
				<a th:href="@{/history}">å†å²</a>
				<a th:href="@{/settings}">è®¾ç½®</a>
				<a th:href="@{/logout}">é€€å‡º</a>
			</div>
		</div>

		<h1>æ—¥å¿—åˆ†æ</h1>

		<!-- ä½¿ç”¨æƒ…å†µ -->
		<div class="usage-info">
			<strong>ä»Šæ—¥ä½¿ç”¨æƒ…å†µï¼š</strong>
			å·²ç”¨ <span th:text="${usage.used}">0</span> / 
			é™é¢ <span th:text="${usage.limit}">20</span> æ¬¡ï¼Œ
			å‰©ä½™ <span th:text="${usage.remaining}">20</span> æ¬¡
		</div>

		<div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

		<!-- åˆ†æè¡¨å• -->
		<form th:action="@{/analyze}" method="post">
			<div class="two-column">
				<div>
					<div class="form-group">
						<label for="logType">æ—¥å¿—ç±»å‹ï¼š</label>
						<select id="logType" name="logType" required>
							<option value="JAVA" th:selected="${defaultType == 'JAVA'}">JAVA</option>
							<option value="SPRING" th:selected="${defaultType == 'SPRING'}">SPRING</option>
						</select>
					</div>
				</div>
				<div>
					<div class="form-group">
						<label>
							<input type="checkbox" name="sanitize" value="true" 
								th:checked="${defaultSanitize != null ? defaultSanitize : true}">
							è‡ªåŠ¨è„±æ•
						</label>
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" name="generateActionList" value="true" checked>
							ç”Ÿæˆè¡ŒåŠ¨æ¸…å•
						</label>
					</div>
					<div class="form-group">
						<label for="depth">è¾“å‡ºæ·±åº¦ï¼š</label>
						<select id="depth" name="depth">
							<option value="FAST" th:selected="${defaultDepth == 'FAST'}">FAST</option>
							<option value="DEEP" th:selected="${defaultDepth == 'DEEP'}">DEEP</option>
						</select>
					</div>
				</div>
			</div>

			<div class="form-group">
				<label for="rawLog">æ—¥å¿—å†…å®¹ï¼ˆæœ€å¤š 8000 å­—ç¬¦ï¼‰ï¼š</label>
				<textarea id="rawLog" name="rawLog" required 
					maxlength="8000" 
					placeholder="è¯·ç²˜è´´æ‚¨çš„æ—¥å¿—å†…å®¹..." 
					th:value="${rawLog}"></textarea>
				<small>å½“å‰å­—ç¬¦æ•°ï¼š<span id="charCount">0</span> / 8000</small>
			</div>

			<div class="form-group">
				<label for="tried">å·²å°è¯•çš„æ’æŸ¥æ­¥éª¤ï¼ˆå¯é€‰ï¼‰ï¼š</label>
				<textarea id="tried" name="tried" 
					maxlength="2000" 
					placeholder="è¯·æè¿°æ‚¨å·²ç»å°è¯•è¿‡çš„æ’æŸ¥æ­¥éª¤ï¼Œä¾‹å¦‚ï¼šæ£€æŸ¥äº†é…ç½®æ–‡ä»¶ã€é‡å¯äº†æœåŠ¡ç­‰..." 
					th:value="${tried}"></textarea>
				<small>å¸®åŠ© AI é¿å…é‡å¤å»ºè®®å·²å°è¯•çš„æ­¥éª¤</small>
			</div>

			<button type="submit" class="btn btn-success">å¼€å§‹åˆ†æ</button>
		</form>

		<!-- åˆ†æç»“æœ -->
		<div th:if="${analysis}" class="analysis-result">
			<h2>åˆ†æç»“æœ</h2>

			<!-- TL;DR å¡ç‰‡ -->
			<div th:if="${analysis.tldr}" class="card card-tldr">
				<h3 class="card-title">TL;DR</h3>
				<p class="card-content" th:text="${analysis.tldr}"></p>
			</div>

			<!-- Top Causes å¡ç‰‡åˆ—è¡¨ -->
			<div th:if="${analysis.topCauses}">
				<h3 style="margin-top: 30px; margin-bottom: 15px;">Top 3 å¯èƒ½åŸå› </h3>
				<div th:each="cause, iterStat : ${analysis.topCauses}" class="card card-cause">
					<div class="card-header">
						<strong class="card-title" th:text="${cause.cause}">åŸå› </strong>
					</div>
					<div class="card-content">
						<!-- ç½®ä¿¡åº¦è¿›åº¦æ¡ -->
						<div class="confidence-container">
							<div class="confidence-label">
								<span>ç½®ä¿¡åº¦: </span>
								<span th:text="${#numbers.formatDecimal(cause.confidence, 0, 2)}">0.00</span>
							</div>
							<div class="progress-bar">
								<div class="progress-fill" 
									th:style="'width: ' + ${cause.confidence * 100} + '%'"
									th:attr="data-confidence=${#numbers.formatDecimal(cause.confidence, 0, 2)}">
								</div>
							</div>
						</div>
						<p class="evidence-text" th:text="${cause.evidence}">è¯æ®</p>
					</div>
				</div>
			</div>

			<!-- Verification Steps å¯å‹¾é€‰æ¸…å• -->
			<div th:if="${analysis.verificationSteps}">
				<h3 style="margin-top: 30px; margin-bottom: 15px;">æœ€çŸ­éªŒè¯æ­¥éª¤</h3>
				<div class="verification-checklist" th:attr="data-analysis-id=${analysis.id}">
					<div th:each="step, iterStat : ${analysis.verificationSteps}" 
						class="card card-step checklist-item"
						th:attr="data-step-index=${iterStat.index}">
						<div class="checklist-header">
							<input type="checkbox" 
								class="step-checkbox"
								th:id="'step-' + ${analysis.id} + '-' + ${iterStat.index}"
								th:attr="data-step-id=${analysis.id + '-' + iterStat.index}">
							<label class="checklist-label" 
								th:for="'step-' + ${analysis.id} + '-' + ${iterStat.index}"
								th:text="${step.step}">æ­¥éª¤</label>
						</div>
						<div class="card-content">
							<p class="step-why" th:text="${step.why}">åŸå› </p>
							<div class="command-container">
								<code class="command-code" th:text="${step.command}">å‘½ä»¤</code>
								<button class="copy-btn-small" 
									th:attr="data-command=${step.command}"
									onclick="copyCommand(this)"
									title="å¤åˆ¶å‘½ä»¤">ğŸ“‹</button>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div th:if="${analysis.suggestedFixes}">
				<h3>å»ºè®®ä¿®å¤</h3>
				<div th:each="fix : ${analysis.suggestedFixes}" class="fix-item">
					<p th:text="${fix.fix}">ä¿®å¤å»ºè®®</p>
					<span class="risk" 
						th:classappend="'risk-' + ${fix.risk.toLowerCase()}" 
						th:text="'é£é™©: ' + ${fix.risk}">é£é™©</span>
				</div>
			</div>

			<div th:if="${analysis.needMoreInfo}">
				<h3>éœ€è¦æ›´å¤šä¿¡æ¯</h3>
				<p th:text="${analysis.needMoreInfo}"></p>
			</div>

			<form th:action="@{/analyze}" method="post" style="margin-top: 20px;">
				<input type="hidden" name="rawLog" th:value="${rawLog}">
				<input type="hidden" name="logType" th:value="${logType}">
				<input type="hidden" name="tried" th:value="${tried}">
				<input type="hidden" name="saveAsReport" value="true">
				<button type="submit" class="btn">ä¿å­˜ä¸ºæŠ¥å‘Š</button>
			</form>
		</div>
	</div>

	<script>
		// å­—ç¬¦è®¡æ•°
		const textarea = document.getElementById('rawLog');
		const charCount = document.getElementById('charCount');
		if (textarea && charCount) {
			textarea.addEventListener('input', function() {
				charCount.textContent = this.value.length;
			});
			if (textarea.value) {
				charCount.textContent = textarea.value.length;
			}
		}

		// å¤åˆ¶å‘½ä»¤åŠŸèƒ½
		function copyCommand(button) {
			const command = button.getAttribute('data-command');
			if (command) {
				navigator.clipboard.writeText(command).then(function() {
					// ä¸´æ—¶æ”¹å˜æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºå¤åˆ¶æˆåŠŸ
					const originalText = button.textContent;
					button.textContent = 'âœ“';
					button.style.background = '#27ae60';
					setTimeout(function() {
						button.textContent = originalText;
						button.style.background = '';
					}, 1000);
				}).catch(function(err) {
					alert('å¤åˆ¶å¤±è´¥: ' + err);
				});
			}
		}

		// Checklist çŠ¶æ€ä¿å­˜å’Œæ¢å¤ï¼ˆä½¿ç”¨ localStorageï¼‰
		document.addEventListener('DOMContentLoaded', function() {
			// æ¢å¤å·²ä¿å­˜çš„å‹¾é€‰çŠ¶æ€
			const checklistItems = document.querySelectorAll('.checklist-item');
			checklistItems.forEach(function(item) {
				const checkbox = item.querySelector('.step-checkbox');
				if (checkbox) {
					const stepId = checkbox.getAttribute('data-step-id');
					const saved = localStorage.getItem('checklist_' + stepId);
					if (saved === 'true') {
						checkbox.checked = true;
						item.classList.add('checked');
					}
				}
			});

			// ç›‘å¬å‹¾é€‰çŠ¶æ€å˜åŒ–
			const checkboxes = document.querySelectorAll('.step-checkbox');
			checkboxes.forEach(function(checkbox) {
				checkbox.addEventListener('change', function() {
					const stepId = this.getAttribute('data-step-id');
					const item = this.closest('.checklist-item');
					if (this.checked) {
						localStorage.setItem('checklist_' + stepId, 'true');
						item.classList.add('checked');
					} else {
						localStorage.removeItem('checklist_' + stepId);
						item.classList.remove('checked');
					}
				});
			});
		});
	</script>
</body>
</html>
