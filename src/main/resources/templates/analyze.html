<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>日志分析 - LogSage</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
	<div class="container">
		<div class="nav">
			<span>LogSage</span>
			<div>
				<a th:href="@{/analyze}">分析</a>
				<a th:href="@{/history}">历史</a>
				<a th:href="@{/settings}">设置</a>
				<a th:href="@{/logout}">退出</a>
			</div>
		</div>

		<h1>日志分析</h1>

		<!-- 使用情况 -->
		<div class="usage-info">
			<strong>今日使用情况：</strong>
			已用 <span th:text="${usage.used}">0</span> / 
			限额 <span th:text="${usage.limit}">20</span> 次，
			剩余 <span th:text="${usage.remaining}">20</span> 次
		</div>

		<div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

		<!-- 分析表单 -->
		<form th:action="@{/analyze}" method="post">
			<div class="two-column">
				<div>
					<div class="form-group">
						<label for="logType">日志类型：</label>
						<select id="logType" name="logType" required>
							<option value="JAVA">JAVA</option>
							<option value="SPRING">SPRING</option>
						</select>
					</div>
				</div>
				<div>
					<div class="form-group">
						<label>
							<input type="checkbox" name="sanitize" value="true" 
								th:checked="${defaultSanitize != null ? defaultSanitize : true}">
							自动脱敏
						</label>
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" name="generateActionList" value="true" checked>
							生成行动清单
						</label>
					</div>
					<div class="form-group">
						<label for="depth">输出深度：</label>
						<select id="depth" name="depth">
							<option value="FAST" th:selected="${defaultDepth == 'FAST'}">FAST</option>
							<option value="DEEP" th:selected="${defaultDepth == 'DEEP'}">DEEP</option>
						</select>
					</div>
				</div>
			</div>

			<div class="form-group">
				<label for="rawLog">日志内容（最多 8000 字符）：</label>
				<textarea id="rawLog" name="rawLog" required 
					maxlength="8000" 
					placeholder="请粘贴您的日志内容..." 
					th:value="${rawLog}"></textarea>
				<small>当前字符数：<span id="charCount">0</span> / 8000</small>
			</div>

			<button type="submit" class="btn btn-success">开始分析</button>
		</form>

		<!-- 分析结果 -->
		<div th:if="${analysis}" class="analysis-result">
			<h2>分析结果</h2>

			<div th:if="${analysis.tldr}">
				<h3>TL;DR</h3>
				<p th:text="${analysis.tldr}"></p>
			</div>

			<div th:if="${analysis.topCauses}">
				<h3>Top 3 可能原因</h3>
				<div th:each="cause : ${analysis.topCauses}" class="cause-item">
					<strong th:text="${cause.cause}">原因</strong>
					<span class="confidence" th:text="'置信度: ' + ${#numbers.formatDecimal(cause.confidence, 0, 2)}">置信度</span>
					<p style="margin-top: 5px;" th:text="${cause.evidence}">证据</p>
				</div>
			</div>

			<div th:if="${analysis.verificationSteps}">
				<h3>最短验证步骤</h3>
				<div th:each="step : ${analysis.verificationSteps}" class="step-item">
					<strong th:text="${step.step}">步骤</strong>
					<p style="margin-top: 5px;" th:text="${step.why}">原因</p>
					<code style="display: block; margin-top: 5px; padding: 5px; background: #f0f0f0; border-radius: 3px;" 
						th:text="${step.command}">命令</code>
				</div>
			</div>

			<div th:if="${analysis.suggestedFixes}">
				<h3>建议修复</h3>
				<div th:each="fix : ${analysis.suggestedFixes}" class="fix-item">
					<p th:text="${fix.fix}">修复建议</p>
					<span class="risk" 
						th:classappend="'risk-' + ${fix.risk.toLowerCase()}" 
						th:text="'风险: ' + ${fix.risk}">风险</span>
				</div>
			</div>

			<div th:if="${analysis.needMoreInfo}">
				<h3>需要更多信息</h3>
				<p th:text="${analysis.needMoreInfo}"></p>
			</div>

			<form th:action="@{/analyze}" method="post" style="margin-top: 20px;">
				<input type="hidden" name="rawLog" th:value="${rawLog}">
				<input type="hidden" name="logType" th:value="${logType}">
				<input type="hidden" name="saveAsReport" value="true">
				<button type="submit" class="btn">保存为报告</button>
			</form>
		</div>
	</div>

	<script>
		// 字符计数
		const textarea = document.getElementById('rawLog');
		const charCount = document.getElementById('charCount');
		if (textarea && charCount) {
			textarea.addEventListener('input', function() {
				charCount.textContent = this.value.length;
			});
			if (textarea.value) {
				charCount.textContent = textarea.value.length;
			}
		}
	</script>
</body>
</html>
